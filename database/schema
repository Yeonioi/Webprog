-- FriendLink Database Schema for SQL Server

-- Create database if it doesn't exist
IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'friendlink')
BEGIN
    CREATE DATABASE friendlink;
END
GO

-- Switch to the friendlink database
USE friendlink;
GO

-- Drop tables if they exist (for clean reinstall)
IF OBJECT_ID('messages', 'U') IS NOT NULL DROP TABLE messages;
IF OBJECT_ID('bookmarks', 'U') IS NOT NULL DROP TABLE bookmarks;
IF OBJECT_ID('reviews', 'U') IS NOT NULL DROP TABLE reviews;
IF OBJECT_ID('services', 'U') IS NOT NULL DROP TABLE services;
IF OBJECT_ID('service_categories', 'U') IS NOT NULL DROP TABLE service_categories;
IF OBJECT_ID('general_categories', 'U') IS NOT NULL DROP TABLE general_categories;
IF OBJECT_ID('referral_rewards', 'U') IS NOT NULL DROP TABLE referral_rewards;
IF OBJECT_ID('referrals', 'U') IS NOT NULL DROP TABLE referrals;
IF OBJECT_ID('referral_milestones', 'U') IS NOT NULL DROP TABLE referral_milestones;
IF OBJECT_ID('users', 'U') IS NOT NULL DROP TABLE users;
GO

-- Users table
CREATE TABLE users (
    id INT PRIMARY KEY IDENTITY(1,1),
    name NVARCHAR(100) NOT NULL,
    email NVARCHAR(100) UNIQUE NOT NULL,
    password NVARCHAR(255) NOT NULL,
    phone NVARCHAR(20),
    location NVARCHAR(100),
    bio NVARCHAR(MAX),
    profile_image NVARCHAR(255),
    referral_code NVARCHAR(20) UNIQUE NOT NULL,
    referred_by INT DEFAULT NULL,
    referral_points INT DEFAULT 0,
    total_referrals INT DEFAULT 0,
    member_since DATETIME DEFAULT GETDATE(),
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (referred_by) REFERENCES users(id) ON DELETE NO ACTION ON UPDATE NO ACTION
);

-- Referrals table
CREATE TABLE referrals (
    id INT PRIMARY KEY IDENTITY(1,1),
    referrer_id INT NOT NULL,
    referred_user_id INT NOT NULL,
    referral_code NVARCHAR(20) NOT NULL,
    status NVARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'rewarded')),
    points_earned INT DEFAULT 0,
    completed_at DATETIME NULL,
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (referrer_id) REFERENCES users(id) ON DELETE NO ACTION ON UPDATE NO ACTION,
    FOREIGN KEY (referred_user_id) REFERENCES users(id) ON DELETE NO ACTION ON UPDATE NO ACTION,
    CONSTRAINT unique_referral UNIQUE (referrer_id, referred_user_id)
);

-- Referral rewards table
CREATE TABLE referral_rewards (
    id INT PRIMARY KEY IDENTITY(1,1),
    user_id INT NOT NULL,
    referral_id INT NOT NULL,
    reward_type NVARCHAR(20) NOT NULL CHECK (reward_type IN ('signup', 'first_service', 'first_booking', 'milestone')),
    points INT NOT NULL,
    description NVARCHAR(MAX),
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE NO ACTION ON UPDATE NO ACTION,
    FOREIGN KEY (referral_id) REFERENCES referrals(id) ON DELETE NO ACTION ON UPDATE NO ACTION
);

-- Referral milestones table
CREATE TABLE referral_milestones (
    id INT PRIMARY KEY IDENTITY(1,1),
    referrals_required INT NOT NULL,
    points_reward INT NOT NULL,
    title NVARCHAR(100) NOT NULL,
    description NVARCHAR(MAX),
    badge_icon NVARCHAR(50),
    is_active BIT DEFAULT 1,
    created_at DATETIME DEFAULT GETDATE()
);

-- General categories table
CREATE TABLE general_categories (
    id INT PRIMARY KEY IDENTITY(1,1),
    name NVARCHAR(100) NOT NULL,
    icon NVARCHAR(10) NOT NULL,
    color NVARCHAR(50) NOT NULL,
    description NVARCHAR(MAX),
    created_at DATETIME DEFAULT GETDATE()
);

-- User-defined service categories table
CREATE TABLE service_categories (
    id INT PRIMARY KEY IDENTITY(1,1),
    general_category_id INT NOT NULL,
    name NVARCHAR(100) NOT NULL,
    created_by INT NOT NULL,
    is_approved BIT DEFAULT 1,
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (general_category_id) REFERENCES general_categories(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE NO ACTION ON UPDATE NO ACTION,
    CONSTRAINT unique_category_name UNIQUE (name)
);

-- Services table
CREATE TABLE services (
    id INT PRIMARY KEY IDENTITY(1,1),
    user_id INT NOT NULL,
    service_category_id INT NOT NULL,
    title NVARCHAR(200) NOT NULL,
    description NVARCHAR(MAX),
    rate NVARCHAR(50),
    location NVARCHAR(100),
    distance NVARCHAR(50),
    image NVARCHAR(255),
    is_featured BIT DEFAULT 0,
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (service_category_id) REFERENCES service_categories(id) ON DELETE NO ACTION ON UPDATE NO ACTION
);

-- Reviews table
CREATE TABLE reviews (
    id INT PRIMARY KEY IDENTITY(1,1),
    service_id INT NOT NULL,
    reviewer_id INT NOT NULL,
    rating DECIMAL(2,1) NOT NULL,
    comment NVARCHAR(MAX),
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (service_id) REFERENCES services(id) ON DELETE CASCADE,
    FOREIGN KEY (reviewer_id) REFERENCES users(id) ON DELETE NO ACTION ON UPDATE NO ACTION
);

-- Bookmarks table
CREATE TABLE bookmarks (
    id INT PRIMARY KEY IDENTITY(1,1),
    user_id INT NOT NULL,
    service_id INT NOT NULL,
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (service_id) REFERENCES services(id),
    CONSTRAINT unique_bookmark UNIQUE (user_id, service_id)
);

-- Messages table
CREATE TABLE messages (
    id INT PRIMARY KEY IDENTITY(1,1),
    sender_id INT NOT NULL,
    receiver_id INT NOT NULL,
    service_id INT,
    message NVARCHAR(MAX) NOT NULL,
    is_read BIT DEFAULT 0,
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE NO ACTION ON UPDATE NO ACTION,
    FOREIGN KEY (receiver_id) REFERENCES users(id) ON DELETE NO ACTION ON UPDATE NO ACTION,
    FOREIGN KEY (service_id) REFERENCES services(id) ON DELETE SET NULL
);
GO

-- Insert referral milestones
INSERT INTO referral_milestones (referrals_required, points_reward, title, description, badge_icon) VALUES
(1, 50, 'First Friend', 'Referred your first friend to FriendLink', 'üåü'),
(5, 250, 'Community Builder', 'Referred 5 friends to FriendLink', 'üèÜ'),
(10, 500, 'Network Master', 'Referred 10 friends to FriendLink', 'üëë'),
(25, 1500, 'Super Connector', 'Referred 25 friends to FriendLink', '‚≠ê'),
(50, 3000, 'Legend', 'Referred 50 friends to FriendLink', 'üíé'),
(100, 7500, 'Ambassador', 'Referred 100 friends to FriendLink', 'üöÄ');

-- Insert general categories
INSERT INTO general_categories (name, icon, color, description) VALUES
('Education', 'üìö', 'bg-blue-100 text-blue-700', 'Tutoring, teaching, training, and educational services'),
('Technology', 'üíª', 'bg-purple-100 text-purple-700', 'IT support, web development, app creation, and tech help'),
('Home & Garden', 'üè†', 'bg-green-100 text-green-700', 'Home repairs, gardening, cleaning, and maintenance'),
('Health & Wellness', '‚ù§Ô∏è', 'bg-red-100 text-red-700', 'Fitness training, yoga, nutrition, and wellness coaching'),
('Creative Services', 'üé®', 'bg-pink-100 text-pink-700', 'Design, photography, writing, music, and arts'),
('Business Services', 'üíº', 'bg-indigo-100 text-indigo-700', 'Consulting, marketing, accounting, and professional services'),
('Personal Care', '‚ú®', 'bg-yellow-100 text-yellow-700', 'Beauty, grooming, styling, and personal services'),
('Transportation', 'üöó', 'bg-orange-100 text-orange-700', 'Moving, delivery, driving, and transportation services'),
('Pets & Animals', 'üêæ', 'bg-teal-100 text-teal-700', 'Pet sitting, dog walking, grooming, and animal care'),
('Events & Entertainment', 'üéâ', 'bg-rose-100 text-rose-700', 'Event planning, catering, entertainment, and celebrations');

-- Insert sample users with referral codes (password is 'password' hashed with bcrypt)
INSERT INTO users (name, email, password, phone, location, bio, profile_image, referral_code, referred_by, referral_points, total_referrals) VALUES
('Jamie Smith', 'jamie.smith@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', '(555) 123-4567', 'Oakwood, CA', 'Hi there! I''m Jamie and I recently moved to Oakwood. I''m looking for help with various services and happy to connect with neighbors.', 'https://images.unsplash.com/photo-1494790108377-be9c29b29330', 'JAMIE2024', NULL, 350, 7),
('Alex Johnson', 'alex.johnson@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', '(555) 234-5678', 'Maple Street', 'Professional handyman with 10+ years experience.', 'https://images.unsplash.com/photo-1540479859555-17af45c78602', 'ALEX2024', 1, 100, 2),
('Sarah Miller', 'sarah.miller@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', '(555) 345-6789', 'Oak Avenue', 'Experienced gardener and landscape designer.', 'https://images.unsplash.com/photo-1599629954294-12aa8b7fb4d4', 'SARAH2024', 1, 50, 1),
('Michael Rodriguez', 'michael.rodriguez@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', '(555) 456-7890', 'Pine Road', 'Loving pet sitter and dog walker.', 'https://images.unsplash.com/photo-1541364983171-a8ba01e95cfc', 'MIKE2024', 1, 0, 0);

-- Insert referrals
INSERT INTO referrals (referrer_id, referred_user_id, referral_code, status, points_earned, completed_at) VALUES
(1, 2, 'JAMIE2024', 'rewarded', 100, DATEADD(day, -30, GETDATE())),
(1, 3, 'JAMIE2024', 'rewarded', 100, DATEADD(day, -20, GETDATE())),
(2, 4, 'ALEX2024', 'completed', 50, DATEADD(day, -10, GETDATE()));

-- Insert sample service categories
INSERT INTO service_categories (general_category_id, name, created_by) VALUES
(3, 'Home Repair & Maintenance', 2),
(3, 'Lawn Care & Landscaping', 3),
(9, 'Pet Sitting & Dog Walking', 4),
(1, 'Math Tutoring', 1),
(1, 'Science Tutoring', 1),
(2, 'Computer Repair', 1),
(2, 'Website Development', 1),
(3, 'House Cleaning', 1),
(5, 'Photography', 1),
(8, 'Moving Help', 1);

-- Insert sample services
INSERT INTO services (user_id, service_category_id, title, description, rate, location, distance, image, is_featured) VALUES
(2, 1, 'Handyman & Home Repair Expert', 'Professional handyman with 10+ years experience. Specializing in small repairs, furniture assembly, and general maintenance.', '$35/hour', 'Maple Street', '0.8 miles away', 'https://images.unsplash.com/photo-1540479859555-17af45c78602', 1),
(3, 2, 'Professional Gardener', 'Experienced gardener offering lawn mowing, garden maintenance, planting, and landscape design services.', '$25/hour', 'Oak Avenue', '1.2 miles away', 'https://images.unsplash.com/photo-1599629954294-12aa8b7fb4d4', 1),
(4, 3, 'Pet Care Specialist', 'Loving pet sitter and dog walker with experience caring for all types of pets. Available for daily walks or vacation care.', '$20/visit', 'Pine Road', '0.5 miles away', 'https://images.unsplash.com/photo-1541364983171-a8ba01e95cfc', 1);

-- Insert sample reviews
INSERT INTO reviews (service_id, reviewer_id, rating, comment) VALUES
(1, 1, 4.9, 'Excellent work! Very professional and on time.'),
(2, 1, 4.7, 'Great job on my lawn. Highly recommend!'),
(3, 1, 5.0, 'Amazing with my dog. Very trustworthy!');